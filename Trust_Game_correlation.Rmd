---
title: "Trust Game reciprocity analysis"
output:
  pdf_document: default
  html_document: default
---

# Load and Define Variables

```{r}
knitr::opts_chunk$set(echo = FALSE)
library(ggplot2)
library(dplyr)
library(tidyr)
library(ggcorrplot)
library(ggpubr)
library(statsr)
library(lme4)
library(lmerTest)
```

# Uploading data type

```{r}
data022822 <- read.csv("TG_Raw_76.csv")
factors<-c("Role","Dyad","Modality","Diagnosis","ID","Sex","Inherited","T_Experience","Medication")
integers<-c("Perception_Mismatch","Total_Alliance","Visits","Age","Task","Goal","Bond","Indiv_Total","Intrusiveness","Previous_Alliance","Lifetime_Therapist_Number","Closeness","Dependence","Anxiety","Avoidance","RFQc","RFQu","Investor_Total","Trustee_Total","Scores_Total","rt1","rt2","rt3","rt4","rt5","rt6","rt7","rt8","rt9","rt10")
numerics<-c("r3","r4","r5","r6","r7","r8","r9","r10","d_rf3","d_rf4","d_rf5","d_rf6","d_rf7","d_rf8","d_rf9","d_rf10","rf1","rf2","rf3","rf4","rf5","rf6","rf7","rf8","rf9","rf10")
data022822[,factors]<-lapply(data022822[,factors], factor)
data022822[,integers]<-lapply(data022822[,integers], as.integer)
data022822[,numerics]<-lapply(data022822[,numerics], as.numeric)
data022822$T_Experience <- factor(data022822$T_Experience, levels=c("<10","11+","100+"))
data022822[data022822 == "N/A" | data022822 == "#VALUE!" | data022822 == ""] <- NA

str(data022822)
summary(data022822$Diagnosis)
summary(data022822[38:74,]$Indiv_Total) #median of patient-rated alliance=74
```

# Mutating and extracting average rf and rt parameters from TG

```{r}
# IF you are skipping rt analysis for now, go right into line 84.
# wide to long form and check for outliers
test<-data022822 %>% 
  pivot_longer(
    cols=starts_with("rt"),
    names_to="round",
    values_to="rt",
    values_drop_na=FALSE
  )
test$round<-factor(test$round, levels=c("rt1","rt2","rt3","rt4","rt5","rt6","rt7","rt8","rt9","rt10"))

ggplot(test, aes(x=rt))+
  geom_histogram()
summary(test$rt)
ggplot(test, aes(x=round, y=rt))+
  geom_point()+
  ylim(0,100000)+
  facet_wrap("ID")

#remove rt>100000 (1.67minutes) #5 data points, 3 persons and pivot back to wide form
test_filtered<-test %>% filter(rt<100000)
rt<-test_filtered %>% 
  pivot_wider(
    id_cols="ID",
    names_from="round",
    values_from="rt",
    values_fill=NA
  )  
data022822<-merge(data022822[,1:55], rt, by="ID", all.x=TRUE)
```

```{r}
# mutate and make mean reapyment
data022822 <- data022822 %>% 
  rowwise() %>% 
  mutate(rf_avg = mean(c(rf1, rf2, rf3, rf4, rf5, rf6, rf7, rf8, rf9, rf10), na.rm = TRUE),
         rt_avg = mean(c(rt1, rt2, rt3, rt4, rt5, rt6, rt7, rt8, rt9, rt10), na.rm = TRUE))

# summarise and plot mean repayment
rf_avg_p_mean<-colMeans(data022822[data022822$Role=="P" & is.nan(data022822$rf_avg)==FALSE,][,'rf_avg'])
rf_avg_t_mean<-colMeans(data022822[data022822$Role=="T",][,'rf_avg']) #should be 0.571

Fig1a <- ggplot(data022822)+
  geom_histogram(data=data022822[data022822$Role=="P",],
                 aes(x=rf_avg), fill="Orange", alpha = 1, position="identity")+
  geom_vline(aes(xintercept = rf_avg_p_mean), colour="Orange", linetype=5)+
  geom_histogram(data=data022822[data022822$Role=="T",],
                 aes(x=rf_avg), fill="Blue", alpha = 0.8, position="identity")+
  geom_vline(aes(xintercept = rf_avg_t_mean), colour="Blue", linetype=5)+
  labs(y="Frequency", x="Mean Repayment",
       tag="A")+
  scale_fill_manual(name="Role", 
                    values=c("Orange", "Blue"), 
                    labels=c("Patient", "Therapist"))

Fig1b <- ggplot(data022822, aes(rf_avg, Indiv_Total, color=Role))  +
  geom_point() +
  geom_smooth(method=lm)+
  scale_color_manual(name="Role",
                     values=c("Orange", "Blue"), 
                     labels=c("Patient", "Therapist")) +
  labs(y="Alliance", x="Mean Repayment",
       tag="B")

ggplot(data022822_p, aes(rf_avg, Closeness, color=Role))  +
  geom_point() +
  geom_smooth(method=lm)+
  scale_color_manual(name="Role",
                     values=c("Orange"), 
                     labels=c("Patient")) +
  labs(y="Attachment Closeness", x="Mean Repayment")

Fig1 <- ggarrange(Fig1a, Fig1b, ncol=2, nrow=1, common.legend = TRUE)
ggsave("plot.png", width=4, height=2)

# split dataframes into patients and therapists

data022822_p<-data022822[data022822$Role=="P",]
data022822_t<-data022822[data022822$Role=="T",]

# test for correlation across alliance & avg_rf and group roles

cor.test(data022822_p$rf_avg, data022822_p$Closeness, method=c("pearson")) 
cor.test(data022822_p$rf_avg, data022822_p$Indiv_Total, alternative="two.sided", method=c("pearson")) 

#inf test
inference(y=rf_avg, x=Role, data=data022822, statistic="mean", type="ci", conf_level=0.95, method="theoretical", alternative="two.sided")

```

# Grouping social signals computationally, fractional change in repayment and repyament, in round 3\~10 and extracting beta, beta_abs, beta_changes in rt

```{r}
#first pivot, r3-10, drf3-10, and rt3-10 per ID
r<-data022822 %>% 
  pivot_longer(
    cols=c("r3", "r4", "r5", "r6", "r7", "r8", "r9", "r10"),
    names_to="round",
    values_to="r",
    values_drop_na=FALSE
  )
d_rf<-data022822 %>% 
  pivot_longer(
    cols=c("d_rf3", "d_rf4", "d_rf5", "d_rf6", "d_rf7", "d_rf8", "d_rf9", "d_rf10"),
    names_to="round",
    values_to="d_rf",
    values_drop_na=FALSE
  )

rf<-data022822 %>% 
  pivot_longer(
    cols=c("rf3", "rf4", "rf5", "rf6", "rf7", "rf8", "rf9", "rf10"),
    names_to="round",
    values_to="rf",
    values_drop_na=FALSE
  )

rt_long<-data022822 %>% 
  pivot_longer(
    cols=c("rt3", "rt4", "rt5", "rt6", "rt7", "rt8", "rt9", "rt10"),
    names_to="round",
    values_to="rt",
    values_drop_na=FALSE
  )

# plotting all round behaviors, after making rf_graph separately (pivoted for rf1~10)

round_behavior<-ggplot(rf_graph, aes(x=round, y=rf, color=Role, fill=Role))+
  geom_point(na.rm=TRUE)+
  geom_line(aes(color=Role, group=ID))+
  stat_summary(fun.data = "mean_cl_boot", alpha=1, color="black")+
  stat_summary_bin(fun = "mean", geom = "line")

round_behavior_min_max<-ggplot(rf_graph[rf_graph$Dyad==c("02374_13&14","02374_29&30","02374_15&16",
                                                         "02374_27&28","02374_63&64","02374_3&4"),], 
                       aes(x=round, y=rf, color=Role, fill=Role))+
  geom_point(na.rm=TRUE)+
  geom_line(aes(color=Role, group=ID))+
  stat_summary(fun.data = "mean_cl_boot", alpha=1)+
  stat_summary_bin(fun = "mean", geom = "line")

# concaneate horizontally

mixed<-cbind(r[,c(1:26,45:47,58:61)],d_rf[,61],rf[,61],rt_long[,61]) #see if all columns and rows before combining.

# distribution of all parameters

ggplot(mixed, aes(x=r, color=ID))+
  geom_histogram(binwidth=0.1)
ggplot(mixed, aes(x=d_rf, color=ID))+
  geom_histogram(binwidth=0.1)
ggplot(mixed, aes(x=rf, color=ID))+
  geom_histogram(binwidth=0.05)
```

# Social intention x Role effect in rf, d_rf, rt 

```{r}
# binarize reciprocity into malevolence vs benevolence
mixed$intention<-ifelse(mixed$r>0,"Benevolence",
                          ifelse(mixed$r<0, "Malevolence",NA))

# delete observations with missing values in r or d_rf & divide into different datasets based on roles (patients vs therapists)
mixed_filtered <- mixed %>% 
  filter(!is.na(r) & !is.na(d_rf)) #75 rounds lost due to missing data. checkpoint.

mixed_filtered$intention<-as.factor(mixed_filtered$intention)
summary(mixed_filtered$intention) #26 neutral intentions. checkpoint.

mixed_t <- mixed_filtered %>% 
  filter(Role == "T")
mixed_p <- mixed_filtered %>% 
  filter(Role == "P")

# plot rf~ intention across all subjects (group mean)

rf_intention<-mixed[is.na(mixed$intention)==FALSE,] %>% 
  group_by(intention, Role) %>% 
  summarise(sd=sd(rf, na.rm=TRUE), mean_rf=mean(rf, na.rm=TRUE), n=n()) %>%   
  mutate(se=sd/sqrt(n))

ggplot(rf_intention, aes(x=intention, y=mean_rf, color=Role, fill=Role))+
  geom_bar(stat="identity", width=0.2, position=position_dodge(width=0.2)) +
  geom_errorbar(
    aes(x=intention, ymin=mean_rf-se, ymax=mean_rf+se, width=0.04), position=position_dodge(width=0.2))+
  labs(x="investor's intention", y="mean repayment fraction")

#plot rt~ intention across all subjects (group mean)

rt_intention<-mixed[is.na(mixed$intention)==FALSE,] %>% 
  group_by(intention, Role) %>% 
  summarise(sd=sd(rt, na.rm=TRUE), mean_rt=mean(rt, na.rm=TRUE), n=n()) %>%   
  mutate(se=sd/sqrt(n))

ggplot(rt_intention, aes(x=intention, y=mean_rt, color=Role, fill=Role))+
  geom_bar(stat="identity", width=0.2, position=position_dodge(width=0.2)) +
  geom_errorbar(
    aes(x=intention, ymin=mean_rt-se, ymax=mean_rt+se, width=0.04), position=position_dodge(width=0.2))+
  labs(x="investor's intention", y="mean reaction time")

# plot d_rf~intention across all subjects (group mean)

d_rf_intention<-mixed[is.na(mixed$intention)==FALSE,] %>% 
  group_by(intention, Role) %>% 
  summarise(sd=sd(d_rf, na.rm=TRUE), mean_d_rf=mean(d_rf, na.rm=TRUE), n=n())%>%
  mutate(se=sd/sqrt(n))

Fig2 <- ggplot(d_rf_intention, aes(x=intention, y=mean_d_rf, fill=Role))+
  geom_bar(stat="identity", width=0.2, position=position_dodge(width=0.2)) +
  geom_errorbar(
    aes(x=intention, ymin=mean_d_rf-se, ymax=mean_d_rf+se, width=0.04), position=position_dodge(width=0.2))+
  labs(x="Therapy partner's intention", y="Mean Fractional Change in Repayment")+
  scale_fill_manual(name="Role", 
                    values=c("Orange", "Blue"), 
                    labels=c("Patient", "Therapist"))

ggsave("plot.png", width=5, height=3)

# before testing sig differences between binary conditions. 

summary(mixed_p$intention) #6 neutral rounds will be removed in patient data
summary(mixed_t$intention) #20 neutral rounds will be removed in therapist data
mixed_p_without_neutral <-mixed_p[is.na(mixed_p$intention)==FALSE,]
mixed_t_without_neutral <-mixed_t[is.na(mixed_t$intention)==FALSE,]

mixed_p_without_neutral %>% 
  filter(intention=="Benevolence")->tbv
mixed_p_without_neutral %>% 
  filter(intention!="Benevolence")->tml

var.test(tbv$d_rf, tml$d_rf) #p>0.05 homoscedacticity 

# run t.test between two conditions

t.test(d_rf~intention, paired=FALSE, vars.equal=TRUE,
       data=mixed_p_without_neutral) #not exactly matched or paired, i.e. some patients had more malevolent rounds than benevolent rounds, error in complete.cases(x,y): not all arguments have the same length. only patient data show sig differences between conditions

# run t.test between two roles within same condition

mixed_filtered[mixed_filtered$intention=="Benevolence",] %>% 
  filter(Role=="T")->tT
mixed_filtered[mixed_filtered$intention=="Benevolence",] %>% 
  filter(Role!="T")->tP

var.test(tT$d_rf, tP$d_rf) #p>0.05 homoscedacticity for benevolence, but p=0.03 for malevolence

t.test(d_rf~Role, paired=FALSE, vars.equal=TRUE,
       data=mixed_filtered[mixed_filtered$intention=="Benevolence",]) 

# 2 x 2 anova analysis for rt, rf, d_rf

aov_rt <- aov(rt ~ intention * Role, 
                data=mixed_filtered[is.na(mixed_filtered$intention)==FALSE,])
aov_rf <- aov(rf ~ intention * Role, 
                data=mixed_filtered[is.na(mixed_filtered$intention)==FALSE,]) #sig with role
aov_d_rf <- aov(d_rf ~ intention * Role, 
                data=mixed_filtered[is.na(mixed_filtered$intention)==FALSE,])
summary(aov_d_rf) # trend sig for intention

```

# Cleaning up data by binarizing clinical variables (e.g. high vs alliance), merging with language correlates, and comparing group means of parameters

```{r}
# checkpoint

test_mixed_p<-mixed_p %>% 
  distinct(ID, .keep_all = TRUE)
summary(test_mixed_p$Bond) #median should be 74 (indiv_total) 24 (bond) 28 (avoidance) 22 (anxiety) rfqc (2.5) rfqu (5.5)

# binarize patients into top half alliance vs bottom half alliance
# now we will work with neutral rounds as well as we are dealing with continuous variables now

mixed_p$alliance_Q<-ifelse(mixed_p$Indiv_Total>74,"Top_Half",
                               "Bottom_Half")
mixed_p$bond_Q<-ifelse(mixed_p$Bond>24,"Top_Half",
                               "Bottom_Half")
mixed_p$avoidance_Q<-ifelse(mixed_p$Avoidance>28,"Top_Half",
                               "Bottom_Half")
mixed_p$anxiety_Q<-ifelse(mixed_p$Anxiety>22,"Top_Half",
                               "Bottom_Half")
mixed_p$rfqc_Q<-ifelse(mixed_p$RFQc>2.5,"Top_Half",
                               "Bottom_Half")
mixed_p$rfqu_Q<-ifelse(mixed_p$RFQu>5.5,"Top_Half",
                               "Bottom_Half")

# factorize variables

factors_2 <- c("alliance_Q", "bond_Q", "avoidance_Q", "anxiety_Q", "rfqc_Q", "rfqu_Q")
mixed_p[,factors_2]<-lapply(mixed_p[,factors_2], factor)

# merge with language correlates by "id" as well

mixed_p_with_lang <- merge(mixed_p, language_TG, by="ID", all.x=TRUE)
summary(mixed_p_with_lang)

# summarize means of rt between high vs low alliance groups (bottom_half=114, top_half=127 observations)

rt_by_alliance_Q <-mixed_p_with_lang[is.na(mixed_p_with_lang$intention)==FALSE,] %>% 
  group_by(alliance_Q, intention) %>% 
  summarise(sd=sd(rt, na.rm=TRUE), mean_rt=mean(rt, na.rm=TRUE), n=n())%>%
  mutate(se=sd/sqrt(n))

ggplot(rt_by_alliance_Q, aes(x=intention, y=mean_rt, fill=alliance_Q))+
  geom_bar(stat="identity", width=0.2, position=position_dodge(width=0.2)) +
  geom_errorbar(
    aes(x=intention, ymin=mean_rt-se, ymax=mean_rt+se, width=0.04), position=position_dodge(width=0.2))+
  labs(x="Therapist's Intention", y="Mean Reaction Time (ms)")+
  scale_fill_manual(name="Alliance Quality", 
                    values=c("Green", "Red"), 
                    labels=c("Top 50%", "Bottom 50%"))

# 2 x 2 anova for impact of alliance * intention on reaction time in decision making
aov_rt_alliance <- aov(rt ~ intention * alliance_Q, 
                data=mixed_p_with_lang[is.na(mixed_p_with_lang$intention)==FALSE,])
summary(aov_rt_alliance) # not significant


# summarize means of rt & d_rf between psych traits (mentalizing capacity, avoidant) group

rt_by_rfqu_Q <-mixed_p_with_lang[is.na(mixed_p_with_lang$intention)==FALSE & is.na(mixed_p_with_lang$rfqu_Q)==FALSE,] %>% 
  group_by(rfqu_Q, intention) %>% 
  summarise(sd=sd(rt, na.rm=TRUE), mean_rt=mean(rt, na.rm=TRUE), n=n())%>%
  mutate(se=sd/sqrt(n))

d_rf_by_rfqu_Q <-mixed_p_with_lang[is.na(mixed_p_with_lang$intention)==FALSE & is.na(mixed_p_with_lang$rfqu_Q)==FALSE,] %>% 
  group_by(rfqu_Q, intention) %>% 
  summarise(sd=sd(d_rf, na.rm=TRUE), mean_d_rf=mean(d_rf, na.rm=TRUE), n=n())%>%
  mutate(se=sd/sqrt(n))

rt_by_avoidance_Q <-mixed_p_with_lang[is.na(mixed_p_with_lang$intention)==FALSE,] %>% 
  group_by(avoidance_Q, intention) %>% 
  summarise(sd=sd(rt, na.rm=TRUE), mean_rt=mean(rt, na.rm=TRUE), n=n())%>%
  mutate(se=sd/sqrt(n))

d_rf_by_avoidance_Q <-mixed_p_with_lang[is.na(mixed_p_with_lang$intention)==FALSE,] %>% 
  group_by(avoidance_Q, intention) %>% 
  summarise(sd=sd(d_rf, na.rm=TRUE), mean_d_rf=mean(d_rf, na.rm=TRUE), n=n())%>%
  mutate(se=sd/sqrt(n))

ggplot(rt_by_avoidance_Q, aes(x=intention, y=mean_rt, fill=avoidance_Q))+
  geom_bar(stat="identity", width=0.2, position=position_dodge(width=0.2)) +
  geom_errorbar(
    aes(x=intention, ymin=mean_rt-se, ymax=mean_rt+se, width=0.04), position=position_dodge(width=0.2))+
  labs(x="Therapist's Intention", y="Mean Reaction Time")+
  scale_fill_manual(name="Attachment Avoidance", 
                    values=c("Green", "Red"), 
                    labels=c("Top 50%", "Bottom 50%"))

ggsave("plot.png", width=5, height=3)

# 2 x 2 anova
aov_rt_avoidance <- aov(rt ~ intention * avoidance_Q, 
                data=mixed_p_with_lang[is.na(mixed_p_with_lang$intention)==FALSE,]) 

summary(aov_d_rf_avoidance) # rfq_u not sig

# t.test 
t.test(d_rf~intention, paired=FALSE, vars.equal=TRUE,
       data=mixed_p_with_lang[is.na(mixed_p_with_lang$intention)==FALSE & mixed_p_with_lang$rfqu_Q=="Top_Half",]) #p=0.06

# rf~rt and d_rf~rt
plot(mixed_p_with_lang$rt, mixed_p_with_lang$rf)
```

# Reciprocity \~ d_rf across binary alliance groups (high vs low) only for patients. Modeling the linear mixed effect model of predicting d_rf \~ r + clinical vars, e.g. alliance, rfqc/u, anxiety, avoidance traits + individual random variance

```{r}
# remove outliers
mixed_p_lme4<-mixed_p_with_lang[mixed_p_with_lang$r > -5 & mixed_p_with_lang$r < 5,]
str(mixed_p_lme4)

# divide r into two columns to be separate predictors (r_high_alliance vs r_low_alliance)
mixed_p_lme4$r_high_alliance <- ifelse(mixed_p_lme4$alliance_Q=="Top_Half",
                                  mixed_p_lme4$r, 0)
mixed_p_lme4$r_low_alliance <- ifelse(mixed_p_lme4$alliance_Q=="Bottom_Half",
                                  mixed_p_lme4$r, 0)

# model 1 - random intercept for individuals / examine group differences of d_rf~r based on alliance group

lm1_0 <- lmer(d_rf ~ 1 + r_high_alliance + r_low_alliance + (1 | ID), data=mixed_p_lme4) #random intercept
lm1_1 <- lmer(d_rf ~ 1 + r_high_alliance + r_low_alliance + (0 + r_high_alliance + r_low_alliance | ID), data=mixed_p_lme4) #random slope
lm1_2 <- lmer(d_rf ~ 1 + r_high_alliance + r_low_alliance + (1 + r_high_alliance + r_low_alliance | ID), data=mixed_p_lme4) #random intercept and slope #but dont make sense

anova(lm1_0, lm1_1, lm1_2)
summary(lm1_0) #winning
plot(lm1_0) # normality check after lmm made

ggplot(mixed_p_lme4, aes(x=r, y=d_rf, fill=alliance_Q))+
  geom_point(aes(fill=alliance_Q))+
  facet_wrap(~alliance_Q)+
  geom_smooth(method="lm", color="black", alpha=0.5)+
  scale_fill_manual(name="Alliance Quality", 
                    values=c("Red", "Green"), 
                    labels=c("Bottom 50%", "Top 50%"))+
  xlim(-5,5)+
  labs(x="Therapist's Reciprocity", y="Fractional Change in Repayment")
  
ggsave("plot.png", height=3, width=6)

# adding additional predictors (rfqu & avoidance attachment)

lm2_0 <- lmer(d_rf ~ 1 + r_high_alliance + r_low_alliance + rfqu_Q + (1 | ID), data=mixed_p_lme4) 
lm2_1 <- lmer(d_rf ~ 1 + r_high_alliance + r_low_alliance + avoidance_Q + (1 | ID), data=mixed_p_lme4)
lm2_2 <- lmer(d_rf ~ 1 + r_high_alliance + r_low_alliance + rfqu_Q + avoidance_Q + (1 | ID), data=mixed_p_lme4)

anova(lm1_0, lm2_1) #lm1_0 is winning


```
